@page "/register"
@layout AuthLayout
@inject IAuthClientService AuthClientService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Register - INDIGI++</PageTitle>

<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative overflow-hidden mt-10">
<div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 right-1/3 text-cyan-900 font-mono text-sm fly-right drop-shadow-lg">{ C++ }</div>
    <div class="absolute bottom-1/3 left-1/4 text-fuchsia-900 font-mono text-sm fly-left drop-shadow-lg">&lt;/code&gt;</div>
    <div class="absolute top-1/2 left-1/6 text-blue-900 font-mono text-sm fly-diagonal drop-shadow-lg">++learn</div>
    <div class="absolute top-10 left-1/3 text-lime-900 font-mono text-sm fly-right delay-100 drop-shadow-lg">#include &lt;iostream&gt;</div>
    <div class="absolute bottom-10 right-1/4 text-amber-900 font-mono text-sm fly-left delay-200 drop-shadow-lg">int main()</div>
    <div class="absolute bottom-1/3 right-1/5 text-red-900 font-mono text-sm fly-left delay-300 drop-shadow-lg">std::cout &lt;&lt; "Hello World";</div>
    <div class="absolute bottom-1/4 left-1/3 text-pink-900 font-mono text-sm fly-right delay-500 drop-shadow-lg">return 0;</div>
    
    <div class="absolute top-1/6 left-1/2 text-teal-900 font-mono text-sm fly-right delay-700 drop-shadow-lg">#define MAX 100</div>
    <div class="absolute bottom-1/6 right-1/2 text-emerald-900 font-mono text-sm fly-left delay-800 drop-shadow-lg">float average;</div>
    <div class="absolute top-1/8 right-1/4 text-violet-900 font-mono text-sm fly-diagonal delay-900 drop-shadow-lg">class Student</div>
    <div class="absolute bottom-1/8 left-1/5 text-indigo-900 font-mono text-sm fly-right delay-1000 drop-shadow-lg">public:</div>
    <div class="absolute top-1/3 left-1/8 text-sky-900 font-mono text-sm fly-left delay-1100 drop-shadow-lg">cout &lt;&lt; total;</div>
    <div class="absolute bottom-1/5 right-1/3 text-orange-900 font-mono text-sm fly-diagonal delay-1200 drop-shadow-lg">vector&lt;int&gt; scores;</div>
</div>

    <div class="max-w-lg w-full space-y-8 relative z-10">
        <!-- Header Section -->
        <div class="text-center">
            <div class="mx-auto w-20 h-20 rounded-2xl flex items-center justify-center mb-6 shadow-2xl transform hover:scale-105 transition-all duration-300 border border-white/10">
                <MudImage Class="rounded-full" Height="100" Width="100" Src="Images/DPCLOGO.jfif"></MudImage>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-emerald-400 via-cyan-500 to-blue-600 bg-clip-text text-transparent mb-2 font-mono">
                INDIGI++
            </h1>
            <h2 class="text-2xl font-semibold text-white mb-2">Join the Community</h2>
            <p class="text-slate-300">Start your C++ programming journey today</p>
        </div>

        <!-- Register Card -->
        <MudCard Class="backdrop-blur-xl bg-white/10 border border-white/20 shadow-2xl rounded-2xl overflow-hidden">
            <MudCardContent Class="p-8">
                <EditForm Model="@registerModel" OnValidSubmit="HandleRegister" FormName="RegisterForm">
                    <DataAnnotationsValidator />

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-6 bg-red-500/20 border border-red-500/30 text-red-200 rounded-xl" ShowCloseIcon="false">
                            <div class="flex items-center space-x-2">
                                <MudIcon Icon="Icons.Material.Filled.Error" Size="Size.Small" />
                                <span>@errorMessage</span>
                            </div>
                        </MudAlert>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <MudAlert Severity="Severity.Success" Class="mb-6 bg-emerald-500/20 border border-emerald-500/30 text-emerald-200 rounded-xl" ShowCloseIcon="false">
                            <div class="flex items-center space-x-2">
                                <MudIcon Icon="Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                <span>@successMessage</span>
                            </div>
                        </MudAlert>
                    }

                    <div class="space-y-6">
                         <!-- Role Selection -->
                        <MudSelect @bind-Value="registerModel.Role"
                                   Label="Your Role is"
                                   Disabled="true"
                                   FullWidth="true"
                                   Variant="Variant.Outlined"
                                   Class="mud-input-dark"
                                   T="UserRole">
                            <div slot="prepend">
                                <MudIcon Icon="Icons.Material.Filled.School" Class="text-blue-400" />
                            </div>
                            <MudSelectItem Value="UserRole.Student">
                                <div class="flex items-center space-x-2">
                                    <MudIcon Icon="Icons.Material.Filled.MenuBook" Size="Size.Small" />
                                    <span>Future Software Engineer/Developer</span>
                                </div>
                            </MudSelectItem>
                        </MudSelect>

                        <!-- Name Fields -->
                        <div class="grid grid-cols-2 gap-4">
                            <MudTextField @bind-Value="registerModel.FirstName"
                                          Label="First Name"
                                          Placeholder="Anz"
                                          Required="true"
                                          RequiredError="First name is required"
                                          FullWidth="true"
                                          Variant="Variant.Outlined"
                                          Class="mud-input-dark mb-3">
                                <div slot="prepend">
                                    <MudIcon Icon="Icons.Material.Filled.Person" Class="text-emerald-400" />
                                </div>
                            </MudTextField>

                            <MudTextField @bind-Value="registerModel.LastName"
                                          Label="Last Name"
                                          Placeholder="De Jesus"
                                          Required="true"
                                          RequiredError="Last name is required"
                                          FullWidth="true"
                                          Variant="Variant.Outlined"
                                          Class="mud-input-dark mb-3">
                                <div slot="prepend">
                                    <MudIcon Icon="Icons.Material.Filled.Person" Class="text-emerald-400" />
                                </div>
                            </MudTextField>
                        </div>

                        <!-- Email Field -->
                        <MudTextField @bind-Value="registerModel.Email"
                                      Label="Email Address"
                                      Placeholder="student@dhvsu.edu.ph"
                                      InputType="InputType.Email"
                                      Required="true"
                                      RequiredError="Email is required"
                                      FullWidth="true"
                                      Variant="Variant.Outlined"
                                      Class="mud-input-dark mb-3">
                            <div slot="prepend">
                                <MudIcon Icon="Icons.Material.Filled.Email" Class="text-cyan-400" />
                            </div>
                        </MudTextField>

                        <!-- Password Fields -->
                        <MudTextField @bind-Value="registerModel.Password"
                                      Label="Password"
                                      Placeholder="Create a strong password"
                                      InputType="@(showPassword ? InputType.Text : InputType.Password)"
                                      Required="true"
                                      RequiredError="Password is required"
                                      FullWidth="true"
                                      Variant="Variant.Outlined"
                                      Class="mud-input-dark"
                                      HelperText="Must contain uppercase, lowercase, number, and special character"
                                      HelperTextOnFocus="true"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                      OnAdornmentClick="TogglePasswordVisibility"
                                      AdornmentAriaLabel="Toggle password visibility">
                            <div slot="prepend">
                                <MudIcon Icon="Icons.Material.Filled.Lock" Class="text-purple-400" />
                            </div>
                        </MudTextField>

                        <MudTextField @bind-Value="registerModel.ConfirmPassword"
                                      Label="Confirm Password"
                                      Placeholder="Confirm your password"
                                      InputType="InputType.Password"
                                      Required="true"
                                      RequiredError="Please confirm your password"
                                      FullWidth="true"
                                      Variant="Variant.Outlined"
                                      Class="mud-input-dark mb-10">
                            <div slot="prepend">
                                <MudIcon Icon="Icons.Material.Filled.LockOpen" Class="text-purple-400" />
                            </div>
                        </MudTextField>

                        <!-- Submit Button -->
                        <MudButton ButtonType="ButtonType.Submit"
                                   Disabled="@isLoading"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   class="h-12 bg-gradient-to-r from-red-800 to-red-700 hover:from-red-900 hover:to-red-800 text-white font-semibold rounded-xl shadow-lg transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed border-0">
                            @if (isLoading)
                            {
                                <div class="flex items-center space-x-2">
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                                    <span>Creating Your Account...</span>
                                </div>
                            }
                            else
                            {
                                <div class="flex items-center space-x-2">
                                    <MudIcon Icon="Icons.Material.Filled.PersonAdd" Size="Size.Small" />
                                    <span class="text-white">Start Learning C++</span>
                                </div>
                            }
                        </MudButton>
                    </div>
                </EditForm>

                <div class="mt-8 pt-6 border-t border-white/10 text-center">
                    <p class="text-sm text-slate-300">
                        Already have an account?
                        <MudLink Href="/" Class="font-semibold text-emerald-400 hover:text-emerald-300 transition-colors duration-200 ml-1">
                            Sign in here
                        </MudLink>
                    </p>
                </div>
            </MudCardContent>
        </MudCard>

        <!-- Benefits Section -->
        <div class="grid grid-cols-3 gap-4 text-center">
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10">
                <MudIcon Icon="Icons.Material.Filled.Quiz" Class="text-emerald-400 text-2xl mb-2" />
                <p class="text-xs text-slate-300 font-medium">Interactive Quizzes</p>
            </div>
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10">
                <MudIcon Icon="Icons.Material.Filled.Code" Class="text-cyan-400 text-2xl mb-2" />
                <p class="text-xs text-slate-300 font-medium">C++ Lessons</p>
            </div>
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10">
                <MudIcon Icon="Icons.Material.Filled.TrendingUp" Class="text-purple-400 text-2xl mb-2" />
                <p class="text-xs text-slate-300 font-medium">Track Progress</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center">
            <p class="text-xs text-slate-400 font-mono">
                Building tomorrow's software engineers, one lesson at a time
            </p>
        </div>
    </div>
</div>

@code {
    private RegisterRequest registerModel = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;
    private bool showPassword = false;

    protected override async Task OnInitializedAsync()
    {
        registerModel.Role = UserRole.Student;

    }

    private async Task HandleRegister()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        isLoading = true;
        StateHasChanged();

        try
        {
            var result = await AuthClientService.RegisterAsync(registerModel);

            Console.WriteLine($"Registration result - Success: {result.Success}, Message: {result.Message}");

            if (result.Success)
            {
                successMessage = result.Message + " Redirecting to login...";
                StateHasChanged();
                Snackbar.Add("Successfully Created Account", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = result.Message ?? "Registration failed";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Registration exception: {ex.Message}");
            errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        StateHasChanged();
    }
}